# Database Migration - File Storage to Supabase

This document explains the changes made to migrate from file-based storage to Supabase database.

## What Changed

### Backend Scripts

#### 1. `.github/scripts/fetch-clips.js`
- **Before**: Saved clips to `votingData/clips.json`
- **After**: 
  - Clears all clips from Supabase database
  - Inserts new clips into Supabase
  - Still saves to JSON for backward compatibility

#### 2. `.github/scripts/submit-vote.js`
- **Before**: Read/write votes from `votingData/votes.json`, checked cookie
- **After**: 
  - Checks if IP has already voted in Supabase
  - Stores vote with IP hash in Supabase
  - No longer uses file storage

#### 3. `.github/scripts/calculate-results.js`
- **Before**: Read from JSON files, saved to `votingData/results.json`
- **After**:
  - Reads clips and votes from Supabase
  - Saves results monthly to Supabase (indexed by year/month)
  - Clears votes after calculation
  - No longer uses file storage

### Frontend Changes

#### 1. `js/supabase-client.js` (NEW)
- Browser-compatible Supabase client
- Loads Supabase SDK from CDN
- Provides functions to fetch clips and results from database
- Handles vote submission directly to database

#### 2. `js/clip-voting.js`
- **Before**: Fetched data from JSON files, used localStorage for vote tracking
- **After**:
  - Tries to fetch from Supabase first, falls back to JSON
  - Gets user's IP address via ipify API
  - Hashes IP client-side using SHA-256
  - Checks if user voted by querying Supabase with IP hash
  - Submits vote directly to Supabase database
  - Still uses localStorage as backup

### GitHub Workflows

All workflows now:
- Install npm dependencies (`npm install`)
- Use `SUPABASE_URL` and `SUPABASE_PUBLISHABLE_KEY` environment variables
- No longer commit/push JSON file changes (data lives in database)

### Database Schema

Three tables in Supabase:

1. **clips**: Stores current month's clips (cleared on each fetch)
2. **votes**: Stores votes by IP hash (cleared after results calculation)
3. **results**: Stores monthly results (persisted, indexed by year/month)

See `supabase-schema.sql` for complete schema.

## Key Improvements

1. **IP-based voting**: No more cookie checking, uses IP hash stored in database
2. **Monthly results**: Results are stored per month, not overwritten
3. **Centralized data**: All data in one database, easier to query and manage
4. **Scalability**: Database handles concurrent access better than file commits
5. **Data persistence**: Results are kept indefinitely, organized by month

## Migration Steps

1. Create Supabase project at https://supabase.com
2. Run the SQL from `supabase-schema.sql` in Supabase SQL Editor
3. Add GitHub secrets:
   - `SUPABASE_URL`
   - `SUPABASE_PUBLISHABLE_KEY`
4. No data migration needed - next clip fetch will populate database
5. Old JSON files remain for backward compatibility

## Testing

To test the integration:

```bash
# Install dependencies
npm install

# Test database connection (requires Supabase to be set up)
node test-db.js
```

## Backward Compatibility

- `votingData/clips.json` is still generated by fetch-clips.js
- Frontend tries Supabase first, then falls back to JSON files
- This allows testing without breaking existing functionality

## Security Notes

- IP addresses are hashed (SHA-256) before storage
- Publishable key is safe for client-side use
- RLS policies enforce read/write permissions
- Each IP can only vote once (database constraint)

## Future Enhancements

Consider adding:
- Service role key for more secure backend operations
- Rate limiting on vote submissions
- Admin dashboard for viewing statistics
- Historical results viewer (by month/year)
